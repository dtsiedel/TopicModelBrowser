// Alex Van Heest
// Single Topic View

// Designed to display unary topic view of data.
// Meant to show a single topic through excerpts from a series of documents.

// Sample data:
var example_title = "Light It Up Blue isn’t autism awareness: it’s Autism Speaks advertisement";
var example_link = "https://leftbrainrightbrain.co.uk/2017/04/02/light-it-up-blue-isnt-autism-awareness-its-autism-speaks-advertisement/"
var example_paragraph = "What do these brain organizations have in common: brain Science Foundation Autistic Self Advocacy Network brain Society of America National Autistic Society Autistica The Marcus brain Center The Thinking Person\u2019s Guide to brain I could list many more.   Besides being brain organizations, they all have this in common: no mention of \u201cLight It Up Blue\u201d on their webpages today. Today is brain Acceptance Day (aka brain Awareness Day).  brain Speaks has been pushing this day with their \u201cLight It Up Blue\u201d campaign.  brain Speaks describes Light It Up Blue as  Each April 2nd, brain Speaks celebrates the start of its signature campaign, Light It Up Blue, along with the international brain community in recognition of UN sanctioned World brain Awareness Day and April, World brain Month. They are clear\u2013it\u2019s not an brain event, it\u2019s an  brain Speaks  event. Apparently \u201calong with the international brain community\u201d.  Which doesn\u2019t appear to be joining in. Blue, by the way, is not the color of brain (it doesn\u2019t really have one).  Blue is the color of brain Speaks. Want to do something for the brain community today?  Take a look at The Thinking Person\u2019s Guide to brain\u2019s article:  brain Acceptance Day & Month: Do This, Not That \u2014 By Matt Carey \n\t\t\tdiv.wpmrec2x{max-width:610px;}\n\t\t\tdiv.wpmrec2x div.u > div{float:left;margin-right:10px;}\n\t\t\tdiv.wpmrec2x div.u > div:nth-child(3n){margin-right:0px;}";

var long_example_title = "An open letter to William Shatner on autism awareness";
var long_example_link = "https://leftbrainrightbrain.co.uk/2017/04/03/an-open-letter-to-william-shatner-on-autism-awareness/";
var long_example = "Mr. Shatner, I see that you have been involved in a rather large tweet storm this weekend, focusing on your support for Autism Speaks. My guess is you would agree that 140 characters at a time is far too limiting to take on a complex discussion. Open letters such as this are as well, but at least I can go into a bit more detail. I hope you take the time to read and at least try to see at least my side of this discussion. First off, yes, I am part of the autism communities. My kid is autistic. I try to guard my kid’s privacy so I don’t give out a lot of details. But let me just say this: if people tell you, “Obviously his kid is ‘high functioning’ so he doesn’t understand what ‘real’ autism is about”, they are wrong. Let me add: anyone who takes the position of discounting another’s voice based on some measure of “severity” of autism is harming our communities. My kid’s challenges are very different, but no less real than those of self-advocates you are hearing on twitter. Just as my kid’s challenges are very different, but no less real, than those of the other kids at his school who will likely never be on twitter. Another way to put this is this: people will likely tell you this is a divide between parents of kids with “real” autism vs. self-advocates with “mild” autism. For what it is worth, some of my kid’s strongest allies are those self-advocates you are hearing from. Some of those who have done the most damage are other parents who, well meaning as they are, have increased the stigma of autism. I haven’t seen that misconception (“real” vs “mild” autism) in your tweets (I haven’t read them all, but I haven’t seen it), but I have seen others. For example: They apparently don't want awareness so they attack (under the guise of educating) those that supported the awareness day. https://t.co/EuUOIVtI4p — William Shatner (@WilliamShatner) April 3, 2017 //platform.twitter.com/widgets.js There is a difference, a big difference, between autism awareness and promoting Autism Speaks. “Light it Up Blue” isn’t an autism community effort, it is an Autism Speaks effort. Most autism organizations don’t promote “light it up blue”. I didn’t find one in my search yesterday other than Autism Speaks. There probably were some, but major organizations were not a part of “light it up blue”. This is why people focused on the avatar you used on Twitter yesterday. It was an Autism Speaks “light it up blue” logo. The blue light bulb logo with the Autsim Speaks puzzle piece. So, why would supporting Autism Speaks spark a strong response? I bet there are as many answers (more even) that tweets directed at you. But let me tell you about a few reasons. First on the list for me is the fact that over the years Autism Speaks has used truly bad depictions of autistics in their promotional materials. Their “I Am Autism” video is an example of this. It’s the sort of inspiration at the expense of the disabled that we saw in generations past. It presents autism as a monster that steals children. It presents the autism community as all the allies, but not the autistics. Seriously, read the transcript on who the community is. You have not properly been introduced to this community of parents and grandparents, of siblings and friends and schoolteachers and therapists and pediatricians and scientists. This is a systemic problem in the autism community: considering it a community of the allies, not the autistics. The I am Autism video is old, and I will admit that Autism Speaks has evolved since then. But they aren’t where we need them to be yet. I saw that people tweeted to you about how Mr. John Robison, an autistic self-advocate, left Autism Speaks. He was at the time the first and only autistic in an important position in Autism Speaks. Please take the time to read his article (in the link I just gave) about his reasons for leaving. Analogies are always flawed, and coming up with a good one here is difficult. But imagine that the NAACP were staffed by well meaning white parents who had adopted African American kids. That African American’s themselves didn’t have a voice in their own advocacy organization. That they didn’t listen when an African American voiced a different opinion than theirs. Please don’t fall for the false dichotomy of whether it should be parents or self-advocates who direct autism advocacy. It should be both. There will always be parents and siblings and others who hold the place at the table for autistics who can’t be there themselves (by the way, this includes many self-advocates. But that is another discussion). But we as parents have to work with the spectrum of our community, or we are only advocates for our own child not the whole. We need to work with adult and non-adult self-advocates. Not in spite of our differences in focus, but because of our difference in focus. I have seen you respond to people that, instead of tweeting at you, perhaps they should focus their attention on organizing their own advocacy efforts. Many have. By the way, tweeting one’s opposition to your actions is advocacy. That said, one of the issues with Autism Speaks is that they have corportatized autism advocacy, branded themselves as the one-stop autism adovcacy location, to the point that local dollars are not available for small, community based advocacy efforts. And they have the power to get off their butts & create or support an organization that aligns with them instead of harassing others. https://t.co/9YYuexUAIv — William Shatner (@WilliamShatner) April 2, 2017 //platform.twitter.com/widgets.js Case in point: you chose the Autism Speaks logo, the Autism Speaks motto (light it up blue), as being a generic autism advocacy effort. Again, this is a big reason why that logo, that icon, garnered the reaction you received. Lastly, let me point out that over its history Autism Speaks has promoted the failed and damaging “autism is a vaccine epidemic” idea. Again, they have evolved over time. But they still have far to go. The vaccines-cause-autism idea is so incredibly damaging to our communities, to autistics, that I could easily triple the length of this piece by discussing it. Let me try to be brief. First off, it’s wrong. Simply and clearly, it’s wrong. You will find parents who believe it, who promote the idea. That doesn’t make it correct. Listen to the parents who promote the vaccines-cause-autism idea. Hear and feel their pain. And ask yourself, if you could help them to not feel that pain, wouldn’t you? If what you are doing is causing more people to feel that pain, wouldn’t you want to change? The path to stopping that pain is by getting good information out. Accuate information. Vaccines do not cause autism. You probably woudn’t believe me if I told you all the fake “cures” sold to autism parents under the guise of “healing vaccine injury”. Chemical castration. Bleach drinks and enemas. Those are but two of the more abusive. There are many more, fake cures which tend to have one thing in common (in addition to being worthless): costing families lots of money. But if you say your “treatment” is for “vaccine injury”, no-one in the vaccines-cause-autism community will speak out against you. That’s where Autism Speaks could and should step up. Could and should make a difference for our communities. Some have tried, but as an organization, this has been a spectacular failure for Autism Speaks. Rob Ring, Chief Science Officer of Autism Speaks (which touts itself as a science based organization) was very clear about this. He made the statement below on the Autism Speaks website: Over the last two decades, extensive research has asked whether there is any link between childhood vaccinations and autism. The results of this research are clear: Vaccines do not cause autism. We urge that all children be fully vaccinated. Rob Ring Here’s the thing–Bob Wright vetoed that message. First he put his own message up together with Dr. Ring’s. Then he disappeared Ring’s message. I hope you took the time to read this. I hope you can take the time to understand the positions here. I don’t ask you to agree, but to understand. I don’t see that so far. Understanding–it’s a form of acceptance. Understand the positions of the people who disagree with you. Accept that they have a different point of view. Even if they are sometimes harsh. By Matt Carey";

var example_wordlist = ["autism", "Light", "Blue", "foundation"];


// Finds most exemplary sentence from article for a given topic. Annotates as it processes each sentence, returns
// an output that includes three sentence-excerpt from the article.
function find_best_excerpt_from_selection(title, doc_number, percent_similarity, original_article, wordlist, link, topic)
{
    var split_list = original_article.split(/[\n\t\r.]/);
    var kw_dict = {};

    for (var k = 0; k < wordlist.length; k++)
    {
        kw_dict[wordlist[k]] = wordlist.length - k;
    }

    var best_total_wordcount = 0;
    var best_sentence_index = -1;
    var all_annotated_sentences = [];

    var current_total_wordcount = 0;

    // loop through the whole string, sentence by sentence
    for (var i = 0; i < split_list.length; i++)
    {
        // setup new annotations index
        all_annotated_sentences.push("");

        //current_total_unique_wordcount = 0;
        current_total_wordcount = 0;

        // split element split_list[i] of words into another array
        //var current_sentence_array = split_list[i].split(" ");
        var temp_par = split_list[i];

        var ea_word_in_current_sentence = split_list[i].split(" ");
        // loop through each word in the current sentence
        for (var j = 0; j < ea_word_in_current_sentence.length; j++)
        {
            var current_word_score = kw_dict[ea_word_in_current_sentence[j].toLowerCase()];
            if (current_word_score != null) // if current word is a keyword
            {
                current_total_wordcount += 1;

                // annotation:
                all_annotated_sentences[i] += "<span class=\"marked\"/>";
                all_annotated_sentences[i] += ea_word_in_current_sentence[j];
                all_annotated_sentences[i] += "</span> ";
            }
            else
            {
                // no annotation:
                all_annotated_sentences[i] += ea_word_in_current_sentence[j];
            }

            if (j + 1 < ea_word_in_current_sentence.length)
            {
                all_annotated_sentences[i] += " ";
            }
        }
        all_annotated_sentences[i] += ". ";

        if (current_total_wordcount > best_total_wordcount)
        {
            best_total_wordcount = current_total_wordcount;
            best_sentence_index = i;
        }
    }

    // what we are left with is the index of the best fitting example for this topic, let's output it
    if (best_sentence_index == -1)  // this would mean nothing was found with > 0 unique / total words: handle with
                                    // explanatory output to HTML (note: in long term, we'd just ignore this case)
    {
        //document.getElementById("sample").innerHTML += "<p>Error: no keyword matches found!</p>"
        return
    }

    var first = -1, second = -1, last = -1;
    // When we present the resulting excerpt, we want to show three sentences no matter where the excerpt is.
    if (best_sentence_index == split_list.length - 1)   // means it's first/last sentence
    {
        first = split_list.length - 3;
        second = split_list.length - 2;
        last = split_list.length - 1;
    }
    else if (best_sentence_index == 0)   // means it's first/last sentence
    {
        first = 0;
        second = 1;
        last = 2;
    }
    else
    {
        first = best_sentence_index - 1;
        second = best_sentence_index;
        last = best_sentence_index + 1;
    }

    // Edit display:
    document.getElementById("sample").innerHTML += "<br>";
    document.getElementById("sample").innerHTML += "<h3><a href='/donut?doc=" + doc_number.toString() + "'>" + title
        + "</a>  <a target = \"_blank\" href='" + link + "'> [original article] </a></h3>";
    document.getElementById("sample").innerHTML += "<h5>" + percent_similarity.toString() + "% topic match</h5>";
    document.getElementById("sample").innerHTML += all_annotated_sentences[first];
    document.getElementById("sample").innerHTML += all_annotated_sentences[second];
    document.getElementById("sample").innerHTML += all_annotated_sentences[last];

    d3.selectAll(".marked").style("background-color", colors[topic]);
}

var timer = function(name) {
    var start = new Date();
    return {
        stop: function() {
            var end  = new Date();
            var time = end.getTime() - start.getTime();
            //console.log('Timer:', name, 'finished in', time, 'ms');
            return time;
        }
    }
};

// Benchmarking method. Takes a number of iterations as input and outputs results to console.
function benchmarking_excerpt_selector(iterations)
{
    var times_list = [];
    console.log("Starting now");
    for (var i = 0; i < iterations; i++)
    {
        var t = timer(i.toString(), times_list);
        find_best_excerpt_from_selection(long_example_title, long_example);
        times_list.push(t.stop());

        // print an update every 100 iterations
        if (i % 100 === 0)
        {
            console.log("Just hit iteration " + i.toString());
            document.getElementById("sample").innerHTML = "";   // clear display; this will eat up lots of time to fill
        }
    }
    document.getElementById("sample").innerHTML = "";

    // print results from times_list
    var total_time = 0;
    for (var i = 0; i < times_list.length; i++)
    {
        total_time += times_list[i];
    }
    var average_time = total_time/iterations;
    console.log("TOTAL TIME: " + total_time.toString());
    console.log("AVERAGE TIME: " + average_time.toString());
}

// Given topic number, sets H2 in HTML to "TOPIC ###"
function define_topicname_from_url(topic)
{
    document.getElementById("topicname").innerHTML = "Topic " + topic + " Summary";
    d3.select("topicname").style("color", colors[topic]);
}

//parses our csv hosted on server
//also does all of the one-time setup and calls our constructDonut function the first time
function getData()
{
    tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("width", "225px")
        .style("background-color", "white")
        .style("padding-left", "5px")
        .style("z-index", "10") //put it in front of the arcs
        .style("border-radius", "10px")
        .style("visibility", "hidden")
        .style("border", "1px solid white")
        .text("Error"); //bad to see this (obviously)

    d3.csv("/topic_frame.csv", function(error, response) {
        csv_data = response;
        csv_data = rectify_csv_data(csv_data);

        var url_string = window.location.href; //fetch document we want to show
        var url = new URL(url_string);
        var topic = url.searchParams.get("t");
       
        if(topic === null)
            topic = randomTopic();

        get_document_full_texts(function()
        {
            define_topicname_from_url(topic);
            constructTopic(topic, 20);
        });
    });
}

//actually make the physical representation of the topic
function constructTopic(topic, numDocs)
{
    document.title = "Topic " + topic;  
    var word_list = reverse_topic_indices[topic].split("_");
    var doc_list = ribbon_data[topic][topic];
    var values = [];
    for(var i = 0; i < doc_list.length; i++)
    {
        var current = doc_list[i];
        var temp = [];
        temp[0] = current;
        temp[1] = csv_data[current][reverse_topic_indices[topic]];
        values.push(temp);
    }
    values.sort(function(x, y){return y[1] - x[1];});
    
    for(var i = 0; i < numDocs; i++)
    {
        var this_doc = values[i];
        find_best_excerpt_from_selection(conditional_clip(document_text[this_doc[0]]["title"], 70), this_doc[0], (this_doc[1] * 100).toFixed(2), document_text[this_doc[0]]["text"], word_list, document_text[this_doc[0]]["url"], topic);
    }
}

//wrapper to call data load functions
function main()
{
    getTopicIndices(getData); //eventually calling it just once will make it available to all views
}

//call main
document.addEventListener("DOMContentLoaded", function(e) {
    main();
});
